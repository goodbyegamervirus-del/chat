<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>chatroom</title>
<style>
  :root{
    --bg:#001014; --panel:#071b1f; --accent:#0fffc1; --muted:#7fd3c2; --text:#c9fff1;
    font-family: "Courier New", monospace;
  }
  html,body{height:100%;margin:0;background:
    radial-gradient(circle at 10% 10%, rgba(0,255,192,0.06), transparent 8%),
    linear-gradient(180deg,#001a1a 0%, #001014 60%);
    color:var(--text);
  }
  .wrap{max-width:920px;margin:18px auto;padding:18px;border-radius:10px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    box-shadow: 0 8px 30px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
    border: 1px solid rgba(0,255,192,0.03);
  }
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  h1{font-size:20px;margin:0;color:var(--accent);letter-spacing:1px}
  p.lead{margin:0;color:var(--muted);font-size:12px}
  .board{display:grid;grid-template-columns:1fr 360px;gap:12px}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
         padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);overflow:auto;}
  .left{min-height:400px;}
  .right{height:420px;}
  form{display:flex;flex-direction:column;gap:8px}
  input[type="text"], textarea{background:transparent;border:1px dashed rgba(0,255,192,0.12);
    padding:10px;border-radius:6px;color:var(--text);outline:none;font-family:inherit}
  textarea{min-height:120px;resize:vertical}
  .row{display:flex;gap:8px;align-items:center}
  button{background:transparent;border:1px solid var(--accent);color:var(--accent);padding:8px 10px;border-radius:6px;
    cursor:pointer;font-weight:700}
  button:hover{background:rgba(0,255,192,0.03)}
  .post{border-top:1px dotted rgba(255,255,255,0.03);padding:10px 6px;display:flex;gap:10px}
  .meta{min-width:110px;font-size:12px;color:var(--muted)}
  .msg{white-space:pre-wrap; font-size:14px}
  .small{font-size:12px;color:var(--muted)}
  .imgthumb{max-width:220px;border-radius:6px;margin-top:8px;border:1px solid rgba(255,255,255,0.03)}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .tag{font-size:11px;padding:4px 6px;border-radius:6px;border:1px solid rgba(255,255,255,0.03)}
  footer{font-size:11px;color:#7fd3c277;margin-top:12px}
  .time{color:var(--muted);font-size:11px}
  .wrap::after{content:"";position:fixed;left:0;top:0;right:0;bottom:0;background-image:
    linear-gradient(rgba(0,0,0,0.02) 1px, transparent 1px);background-size:100% 3px;pointer-events:none;opacity:0.1}
  @media(max-width:820px){.board{grid-template-columns:1fr;}.right{order:2}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>RetroBoard</h1>
    <p class="lead">for the homies to chat during classes and stuff</p>
  </header>

  <div class="board">
    <div class="panel left" id="feed" aria-live="polite">
      <div id="status" class="small">Initializing...</div>
      <div id="posts"></div>
    </div>

    <div class="panel right">
      <form id="composer" onsubmit="return false;">
        <label class="small">Name (optional)</label>
        <input id="name" type="text" maxlength="40" placeholder="anon / choose a handle">

        <label class="small">Message</label>
        <textarea id="text" maxlength="2000" placeholder="Say something retro..."></textarea>

        <label class="small">Attach image (optional — small is best)</label>
        <input id="file" type="file" accept="image/*">

        <div class="row controls">
          <button id="postBtn" type="button">Post</button>
          <button id="clearBtn" type="button">Clear</button>
          <div class="tag">No accounts • Auto-updates</div>
          <div class="tag" id="peerCount">peers: —</div>
        </div>

        <div class="small" style="margin-top:6px">
        </div>
      </form>
      <footer>made by galaxydev</footer>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.min.js"></script>

<script>
(function(){
  const statusEl = document.getElementById('status');
  const postsEl = document.getElementById('posts');
  const peerCountEl = document.getElementById('peerCount');
  const postBtn = document.getElementById('postBtn');
  const clearBtn = document.getElementById('clearBtn');
  const fileInput = document.getElementById('file');
  const nameInput = document.getElementById('name');
  const textInput = document.getElementById('text');
  const gun = Gun({
    peers: [
      'https://gun-manhattan.herokuapp.com/gun'
    ]
  });

  const board = gun.get('retroboard').get('posts');
  function escapeHtml(s){
    if(!s) return '';
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;');
  }
  function renderPost(data){
    if(!data || !data.id) return;
    let existing = document.getElementById('post-'+data.id);
    const dt = new Date(data.ts || Date.now());
    const timeStr = dt.toLocaleString();
    const name = escapeHtml(data.name || 'anon');
    const text = escapeHtml(data.text || '');
    const img = data.image || null;

    const html = `
      <div class="post" id="post-${data.id}">
        <div class="meta">
          <div><strong>${name}</strong></div>
          <div class="time">${timeStr}</div>
          <div class="small">id:${data.id.slice(0,8)}</div>
        </div>
        <div class="msg">
          <div>${text.replace(/\n/g,'<br>')}</div>
          ${ img ? `<img class="imgthumb" src="${img}" alt="attached image">` : '' }
        </div>
      </div>
    `;

    if(existing){
      existing.outerHTML = html;
    } else {
      postsEl.insertAdjacentHTML('afterbegin', html);
    }
  }
  board.map().on(function(node, id){
    if(!node) return;
    if(!node.id) node.id = id || (Math.random().toString(36).slice(2,10));
    try{ renderPost(node); }catch(e){ console.error(e) }
  });
  statusEl.textContent = 'Connected: attempting peer sync...';
  setInterval(()=> {
    const peers = gun.back && gun.back('opt') && gun.back('opt').peers;
    let count = 0;
    try {
      if(peers) count = Object.keys(peers).length;
    } catch(e){}
    peerCountEl.textContent = 'peers: ' + count;
    if(count>0) statusEl.textContent = 'Connected • syncing with peers';
    else statusEl.textContent = 'Offline/local only (no peers connected)';
  }, 2000);
  async function makePost(){
    const name = (nameInput.value || 'anon').slice(0,40);
    const text = (textInput.value || '').slice(0,2000).trim();
    if(!text && !fileInput.files.length){
      alert('Write something or attach an image.');
      return;
    }

    postBtn.disabled = true;
    postBtn.textContent = 'Posting…';

    let imageData = null;
    if(fileInput.files && fileInput.files[0]){
      imageData = await readFileAsDataURL(fileInput.files[0]);
      if(imageData.length > 600000){
        if(!confirm('Image looks large and may sync slowly. Continue?')){ postBtn.disabled=false; postBtn.textContent='Post'; return; }
      }
    }

    const id = Math.random().toString(36).slice(2,10) + '-' + Date.now().toString(36);
    const obj = { id, name, text, image: imageData, ts: Date.now() };
    board.get(id).put(obj);
    board.set(obj);
    textInput.value = '';
    fileInput.value = '';
    postBtn.disabled = false;
    postBtn.textContent = 'Post';
  }

  function readFileAsDataURL(file){
    return new Promise((res, rej) => {
      const fr = new FileReader();
      fr.onload = e => res(e.target.result);
      fr.onerror = e => rej(e);
      fr.readAsDataURL(file);
    });
  }

  postBtn.addEventListener('click', makePost);
  clearBtn.addEventListener('click', () => {
    nameInput.value=''; textInput.value=''; fileInput.value='';
  });
  setTimeout(()=> {
    const seeded = localStorage.getItem('retroboard.seeded');
    if(!seeded){
      const demo = {
        id: 'welcome-'+Date.now(),
        name: 'system',
        text: 'Welcome to RetroBoard! No accounts — open this file on another device to sync messages.',
        ts: Date.now()
      };
      board.set(demo);
      localStorage.setItem('retroboard.seeded','1');
    }
  }, 1500);

})();
</script>
</body>
</html>
